<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="{{ url_for('static', filename='js/global_scroll.js') }}"></script>
    <meta charset="UTF-8">
    <meta name="description" content="–î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —á–µ–∫–∞ –Ω–∞ –ü–æ–î–ï–õ–ò!">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–æ–Ω—Ç–∞–∫—Ç—ã</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –í–´–®–ï –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã -->
    <!-- –û–Ω –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω Flask/Jinja2 –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ —à–∞–±–ª–æ–Ω–∞ -->
    <script>
        // –ü–µ—Ä–µ–¥–∞–µ–º URL'—ã –∏–∑ Flask (Jinja2) –≤ JavaScript
        const defaultExamplePhotoUrl = "{{ url_for('static', filename='images/example_contact.png') }}";
        const noPhotoUrl = "{{ url_for('static', filename='images/no_photo.png') }}";
        // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã 'example_contact.png' –∏ 'no_photo.png'
        // –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ø–∞–ø–∫–µ static/images –≤–∞—à–µ–≥–æ Flask-–ø—Ä–æ–µ–∫—Ç–∞.
    </script>
</head>
<body id="page-contacts">
    <!---->
    <div class="ad-widget">
        <div class="ad-widget-content">
            <script src="//s.contemo.ru/c.js"></script><div id="bresults"><script async defer>cbanner.load(23792, "contemo.ru");</script></div>      
        </div>
    </div>
    <!--============================================ -->
    <!-- <<< –î–û–ë–ê–í–õ–ï–ù –•–ï–î–ï–† >>> -->
    <div class="header contacts-header"> <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –∫–ª–∞—Å—Å .header, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π -->
        <div class="logo">–ü–æ–î–ï–õ–ò!</div>
        <div>–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤</div> <!-- –ü–æ–¥–ø–∏—Å—å –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
    </div>
    <!-- <<< –ö–û–ù–ï–¶ –•–ï–î–ï–†–ê >>> -->
    <div class="policy-footer">
        <a href="/privacy">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
    </div>
    <div class="container">
        <div class="container-content"> <!-- <<< –ù–û–í–ê–Ø –û–ë–ï–†–¢–ö–ê >>> -->
            <div id="contact-list">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–º —Å–ø–∏—Å–∫–µ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–æ —Å—é–¥–∞, –µ—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–µ—Ç -->
            </div>
            <div class="bottom-actions">
                <button id="add-contact-btn">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
                <button id="history-btn">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</button>
            </div>
        </div> <!-- <<< –ö–û–ù–ï–¶ –û–ë–ï–†–¢–ö–ò >>> -->
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ò–°–¢–û–†–ò–ò -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-history" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            <h2>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
            <ul id="history-list">
                <!-- –≠–ª–µ–º–µ–Ω—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–æ —Å—é–¥–∞ -->
            </ul>
            <button id="clear-history-btn" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –î–û–ë–ê–í–õ–ï–ù–ò–Ø/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –∫–æ–Ω—Ç–∞–∫—Ç–∞ -->
    <div id="add-contact-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-add" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            <h2 id="add-contact-modal-title">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h2>
            <form id="add-contact-form" class="modal-form" novalidate> <!-- –î–æ–±–∞–≤–ª–µ–Ω novalidate –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ JS -->
                <div class="photo-upload-container">
                    <img id="contact-photo-preview" src="" alt="–§–æ—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞"> <!-- src –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω JS -->
                    <div>
                        <label for="contact-photo-input" class="file-upload-label">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</label>
                        <input type="file" id="contact-photo-input" accept="image/*">
                        <span id="photo-file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                    </div>
                </div>
                <!-- –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å "required", —É–±—Ä–∞–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ -->
                <label for="contact-name-input" class="required">–ò–º—è –∏ –§–∞–º–∏–ª–∏—è:</label>
                <input type="text" id="contact-name-input" required placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                <label for="contact-phone-input">–¢–µ–ª–µ—Ñ–æ–Ω (11 —Ü–∏—Ñ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä 79...):</label>
                <input type="tel" id="contact-phone-input" placeholder="79123456789" pattern="[78][0-9]{10}"> <!-- –î–æ–±–∞–≤–ª–µ–Ω pattern –¥–ª—è –±–∞–∑–æ–≤–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
                <label for="contact-vk-input">–°—Å—ã–ª–∫–∞ VK (–ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ vk.me):</label>
                <input type="url" id="contact-vk-input" placeholder="https://vk.com/username_or_id">
                <label for="contact-tg-input">Telegram (@username –∏–ª–∏ —Å—Å—ã–ª–∫–∞):</label>
                <input type="text" id="contact-tg-input" placeholder="@username –∏–ª–∏ https://t.me/username">
                <div class="modal-actions">
                    <button type="button" id="cancel-add-btn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" id="save-contact-btn" class="submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ó–ê–ü–†–û–°–ê –°–£–ú–ú–´ -->
    <div id="amount-request-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-amount" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            <h2 id="amount-request-modal-title">–ó–∞–ø—Ä–æ—Å —Å—É–º–º—ã</h2>
            <form id="amount-request-form" class="modal-form" novalidate>
                <p id="amount-request-info">–ó–∞–ø—Ä–æ—Å –¥–ª—è: <b></b> —á–µ—Ä–µ–∑ <b></b></p>
                <label for="request-amount-input">–°—É–º–º–∞ (‚ÇΩ)*:</label>
                <input type="number" id="request-amount-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" required min="0.01" step="any">
                <div id="amount-error-message" class="input-error-message">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é —Å—É–º–º—É.</div>
                <div class="modal-actions">
                    <button type="button" id="cancel-amount-btn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" id="send-request-btn" class="submit-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
                </div>
            </form>
        </div>
    </div>
        <!-- –ù–∏–∂–Ω–∏–π –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–π –±–∞—Ä -->
        <footer class="footer-nav">
            <a href="{{ url_for('index') }}" class="nav-item">
                <!-- –ò–∫–æ–Ω–∫–∞ –°–∫–∞–Ω–µ—Ä (–ó–ê–ú–ï–ù–ï–ù–ê) -->
                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"> <path d="M80-720v-200h200v80H160v120H80Zm720 0v-120H680v-80h200v200h-80ZM80-40v-200h80v120h120v80H80Zm600 0v-80h120v-120h80v200H680ZM280-240h400v-480H280v480Zm0 80q-33 0-56.5-23.5T200-240v-480q0-33 23.5-56.5T280-800h400q33 0 56.5 23.5T760-720v480q0 33-23.5 56.5T680-160H280Zm80-400h240v-80H360v80Zm0 120h240v-80H360v80Zm0 120h240v-80H360v80Zm-80 80v-480 480Z"/></svg>
                <span class="nav-label">–°–∫–∞–Ω–µ—Ä</span>
            </a>
            <a href="{{ url_for('contacts') }}" class="nav-item">
                 <!-- –ò–∫–æ–Ω–∫–∞ –ö–æ–Ω—Ç–∞–∫—Ç—ã (–ó–ê–ú–ï–ù–ï–ù–ê) -->
                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q53 0 100-15.5t86-44.5q-39-29-86-44.5T480-280q-53 0-100 15.5T294-220q39 29 86 44.5T480-160Zm0-360q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0-60Zm0 360Z"/></svg>
                <span class="nav-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
            </a>
            <a href="{{ url_for('share') }}" class="nav-item">
                 <!-- –ò–∫–æ–Ω–∫–∞ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è (–ó–ê–ú–ï–ù–ï–ù–ê) -->
                 <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M680-80q-50 0-85-35t-35-85q0-6 3-28L282-392q-16 15-37 23.5t-45 8.5q-50 0-85-35t-35-85q0-50 35-85t85-35q24 0 45 8.5t37 23.5l281-164q-2-7-2.5-13.5T560-760q0-50 35-85t85-35q50 0 85 35t35 85q0 50-35 85t-85 35q-24 0-45-8.5T598-672L317-508q2 7 2.5 13.5t.5 14.5q0 8-.5 14.5T317-452l281 164q16-15 37-23.5t45-8.5q50 0 85 35t35 85q0 50-35 85t-85 35Zm0-80q17 0 28.5-11.5T720-200q0-17-11.5-28.5T680-240q-17 0-28.5 11.5T640-200q0 17 11.5 28.5T680-160ZM200-440q17 0 28.5-11.5T240-480q0-17-11.5-28.5T200-520q-17 0-28.5 11.5T160-480q0 17 11.5 28.5T200-440Zm480-280q17 0 28.5-11.5T720-760q0-17-11.5-28.5T680-800q-17 0-28.5 11.5T640-760q0 17 11.5 28.5T680-720Zm0 520ZM200-480Zm480-280Z"/></svg>
                <span class="nav-label">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
            </a>
        </footer>
        
        <script>
            (function() { // –ò—Å–ø–æ–ª—å–∑—É–µ–º IIFE –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
              const CONSENT_KEY = 'consentMessageShown_v1'; // –ö–ª—é—á –¥–ª—è localStorage
              const title = "–í–ù–ò–ú–ê–ù–ò–ï!"; // –í–∞—à –∑–∞–≥–æ–ª–æ–≤–æ–∫
              const body = "–ü—Ä–æ–¥–æ–ª–∂–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏, –∏–∑–ª–æ–∂–µ–Ω–Ω–æ–π –ø–æ –∞–¥—Ä–µ—Å—É: https://podeli.oneserver.linkpc.net/privacy";
          
              // –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ: –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –¥–≤–µ –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ + —Ç–µ–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è
              const message = title + "\n\n" + body;
          
              function showConsentMessage() {
                if (localStorage.getItem(CONSENT_KEY) !== 'true') {
                  alert(message); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º)
                  try {
                    localStorage.setItem(CONSENT_KEY, 'true');
                    console.log('–§–ª–∞–≥ —Å–æ–≥–ª–∞—Å–∏—è (consentMessageShown) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
                  } catch (e) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–ª–∞–≥ —Å–æ–≥–ª–∞—Å–∏—è –≤ localStorage:', e);
                  }
                }
              }
          
              if (localStorage.getItem(CONSENT_KEY) !== 'true') {
                console.log('–§–ª–∞–≥ —Å–æ–≥–ª–∞—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞.');
                document.addEventListener('click', showConsentMessage, { once: true, capture: true });
              } else {
                console.log('–§–ª–∞–≥ —Å–æ–≥–ª–∞—Å–∏—è —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ.');
              }
          
            })(); // –ö–æ–Ω–µ—Ü IIFE
        </script>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <script>
        // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
        const contactListContainer = document.getElementById('contact-list');
        const addContactButton = document.getElementById('add-contact-btn');
        const historyButton = document.getElementById('history-btn');

        // –ò—Å—Ç–æ—Ä–∏—è
        const historyModal = document.getElementById('history-modal');
        const historyList = document.getElementById('history-list');
        const modalCloseHistoryButton = document.getElementById('modal-close-history');
        const clearHistoryButton = document.getElementById('clear-history-btn');

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ö–æ–Ω—Ç–∞–∫—Ç–∞
        const addContactModal = document.getElementById('add-contact-modal');
        const addContactForm = document.getElementById('add-contact-form');
        const addContactModalTitle = document.getElementById('add-contact-modal-title');
        const modalCloseAddButton = document.getElementById('modal-close-add');
        const saveContactButton = document.getElementById('save-contact-btn');
        const cancelAddButton = document.getElementById('cancel-add-btn');
        const photoInput = document.getElementById('contact-photo-input');
        const photoPreview = document.getElementById('contact-photo-preview');
        const photoFileName = document.getElementById('photo-file-name');
        const nameInput = document.getElementById('contact-name-input');
        const phoneInput = document.getElementById('contact-phone-input');
        const vkInput = document.getElementById('contact-vk-input');
        const tgInput = document.getElementById('contact-tg-input');

        // –ó–∞–ø—Ä–æ—Å –°—É–º–º—ã
        const amountRequestModal = document.getElementById('amount-request-modal');
        const amountRequestForm = document.getElementById('amount-request-form');
        // const amountRequestModalTitle = document.getElementById('amount-request-modal-title'); // –£–∂–µ –µ—Å—Ç—å –≤ DOM, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ JS –Ω–∞–ø—Ä—è–º—É—é
        const amountRequestInfo = document.getElementById('amount-request-info');
        const modalCloseAmountButton = document.getElementById('modal-close-amount');
        const amountInput = document.getElementById('request-amount-input');
        const amountErrorMessage = document.getElementById('amount-error-message');
        const cancelAmountButton = document.getElementById('cancel-amount-btn');
        const sendRequestButton = document.getElementById('send-request-btn');

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let currentPhotoDataUrl = null; // –•—Ä–∞–Ω–∏—Ç –¢–û–õ–¨–ö–û dataURL –Ω–æ–≤–æ–≥–æ/–∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ
        let contactToEditId = null; // ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
        const CONTACTS_STORAGE_KEY = 'myContactsList_v4_local'; // –û–±–Ω–æ–≤–∏–ª –∫–ª—é—á –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        const HISTORY_STORAGE_KEY = 'myContactsHistory_v4_req'; // –û–±–Ω–æ–≤–∏–ª –∫–ª—é—á

        // --- –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å Local Storage ---
        function loadFromStorage(key, defaultValue = []) {
            const storedData = localStorage.getItem(key);
            if (storedData) {
                try {
                    const parsed = JSON.parse(storedData);
                    return Array.isArray(parsed) ? parsed : defaultValue;
                } catch (e) {
                    console.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage (–∫–ª—é—á: ${key}):`, e);
                    // –í–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –æ—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    // localStorage.removeItem(key);
                    return defaultValue;
                }
            }
            return defaultValue;
        }

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                 console.error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ localStorage (–∫–ª—é—á: ${key}):`, e);
                 alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ${key === CONTACTS_STORAGE_KEY ? '–∫–æ–Ω—Ç–∞–∫—Ç—ã' : '–∏—Å—Ç–æ—Ä–∏—é'}. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.`);
            }
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ---
        function getDefaultContacts() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, —Å–æ–∑–¥–∞–Ω–Ω—É—é —Å –ø–æ–º–æ—â—å—é url_for –∏–∑ Flask
            return [
                { id: `default-${Date.now()}`, name: "–ü—Ä–∏–º–µ—Ä –ö–æ–Ω—Ç–∞–∫—Ç–∞", photo: defaultExamplePhotoUrl, phone: null, vk: "https://vk.com/durov", tg:"@durov" },
            ];
        }

        let contacts = loadFromStorage(CONTACTS_STORAGE_KEY, getDefaultContacts()).map(contact => ({
            ...contact,
            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —É –≤—Å–µ—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –µ—Å—Ç—å –ø–æ–ª–µ photo (–ª–∏–±–æ URL, –ª–∏–±–æ noPhotoUrl)
            photo: contact.photo || noPhotoUrl
        }));

        let transferHistory = loadFromStorage(HISTORY_STORAGE_KEY);

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –°–ø–∏—Å–∫–∞ –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ ---
        function renderContacts() {
            contactListContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if (contacts.length === 0) {
                contactListContainer.innerHTML = '<p>–°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç!</p>';
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏ (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è)
            const sortedContacts = [...contacts].sort((a, b) =>
                (a.name || "").toLowerCase().localeCompare((b.name || "").toLowerCase())
            );

            sortedContacts.forEach((contact) => {
                const card = document.createElement('div');
                card.classList.add('contact-card');
                card.dataset.contactId = contact.id; // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∫–æ–Ω—Ç–∞–∫—Ç–∞

                const photoUrl = contact.photo || noPhotoUrl; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
                const phoneDisplay = contact.phone ? `+${contact.phone}` : '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω';
                const hasVk = contact.vk && contact.vk.trim() !== '';
                const hasTg = contact.tg && contact.tg.trim() !== '';

                card.innerHTML = `
                    <div class="contact-photo">
                        <img src="${photoUrl}" alt="–§–æ—Ç–æ ${contact.name || '–∫–æ–Ω—Ç–∞–∫—Ç–∞'}" onerror="this.onerror=null; this.src='${noPhotoUrl}';"> <!-- Fallback –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                    </div>
                    <div class="contact-details">
                         <div class="contact-name">${contact.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                         <div class="contact-phone-display">${phoneDisplay}</div>
                         <div class="contact-actions">
                            ${!hasVk && !hasTg ? '<span class="no-links-placeholder">–ù–µ—Ç —Å—Å—ã–ª–æ–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞</span>' : ''}
                            ${hasVk ? `<button data-link="${contact.vk}" data-type="vk" class="action-button vk-request-btn" title="–°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –≤ VK">–ó–∞–ø—Ä–æ—Å VK</button>` : ''}
                            ${hasTg ? `<button data-username="${contact.tg}" data-type="tg" class="action-button tg-request-btn" title="–°–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –≤ Telegram">–ó–∞–ø—Ä–æ—Å TG</button>` : ''}
                             <button class="action-button delete-button" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç">–£–¥–∞–ª–∏—Ç—å</button>
                             <button class="action-button edit-button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                         </div>
                    </div>
                `;
                contactListContainer.appendChild(card);
            });
        }

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ò—Å—Ç–æ—Ä–∏–∏ ---
        function renderHistory() {
            historyList.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            const hasHistory = transferHistory.length > 0;

            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏ –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏
            clearHistoryButton.style.display = hasHistory ? 'block' : 'none';
            clearHistoryButton.disabled = !hasHistory;

            if (!hasHistory) {
                historyList.innerHTML = '<li class="no-history">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞.</li>';
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏: —Å–∞–º—ã–µ –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
            const sortedHistory = [...transferHistory].sort((a, b) => b.timestamp - a.timestamp);

            sortedHistory.forEach(entry => {
                const li = document.createElement('li');
                const date = new Date(entry.timestamp).toLocaleString('ru-RU', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º—ã —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ –∏ –∑–Ω–∞–∫–æ–º —Ä—É–±–ª—è
                const amountFormatted = entry.amount ?
                    `${entry.amount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0, maximumFractionDigits: 2 })}`
                    : ''; // –í—ã–≤–æ–¥–∏–º —Å—É–º–º—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å

                let typeText = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è';
                let typeClass = '';
                if (entry.type === 'request_vk') {
                    typeText = '–ó–∞–ø—Ä–æ—Å VK';
                    typeClass = 'history-type-vk';
                } else if (entry.type === 'request_tg') {
                    typeText = '–ó–∞–ø—Ä–æ—Å TG';
                    typeClass = 'history-type-tg';
                }

                li.innerHTML = `
                    <div class="history-details">
                        <span class="history-type ${typeClass}">${typeText}</span> –¥–ª—è <b>${entry.contactName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</b>
                        <span class="history-timestamp">${date}</span>
                    </div>
                    ${amountFormatted ? `<span class="history-amount">${amountFormatted}</span>` : ''}
                `;
                historyList.appendChild(li);
            });
        }

        // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ó–∞–ø–∏—Å–∏ –≤ –ò—Å—Ç–æ—Ä–∏—é ---
        function addHistoryEntry(type, contact, amount = null) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—É–º–º—É –≤ —á–∏—Å–ª–æ –∏–ª–∏ null
            const numericAmount = (typeof amount === 'number' && !isNaN(amount) && amount > 0) ? amount : null;
            const newEntry = {
                type: type, // 'request_vk' –∏–ª–∏ 'request_tg'
                contactName: contact.name || '–ë–µ–∑ –∏–º–µ–Ω–∏',
                amount: numericAmount,
                timestamp: Date.now() // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
            };
            transferHistory.push(newEntry); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
            saveToStorage(HISTORY_STORAGE_KEY, transferHistory); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
             // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
             if (historyModal.classList.contains('visible')) {
                 renderHistory();
             }
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ú–æ–¥–∞–ª—å–Ω—ã–º–∏ –û–∫–Ω–∞–º–∏ ---
        function openModal(modalElement) {
            modalElement.classList.add('visible');
            // –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å –∫ body –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞ —Ñ–æ–Ω–∞
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalElement) {
            modalElement.classList.remove('visible');
            // –£–±—Ä–∞—Ç—å –∫–ª–∞—Å—Å —Å body
            document.body.style.overflow = '';
             // –°–±—Ä–æ—Å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è –º–æ–¥–∞–ª–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            if (modalElement === addContactModal) {
                 resetAddContactForm();
            } else if (modalElement === amountRequestModal) {
                resetAmountRequestForm();
            }
        }

        // --- –õ–æ–≥–∏–∫–∞ –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –û–∫–Ω–∞ –î–æ–±–∞–≤–ª–µ–Ω–∏—è/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
        function resetAddContactForm() {
            addContactForm.reset(); // –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            photoPreview.src = noPhotoUrl; // –°—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É
            photoFileName.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
            currentPhotoDataUrl = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
            contactToEditId = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
             // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –æ—à–∏–±–æ–∫, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏
            nameInput.classList.remove('invalid');
            phoneInput.classList.remove('invalid');
            vkInput.classList.remove('invalid');
            tgInput.classList.remove('invalid');
        }

        function showAddContactModal(contactIdToEdit = null) {
            resetAddContactForm(); // –ù–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

            if (contactIdToEdit) {
                const contact = contacts.find(c => String(c.id) === String(contactIdToEdit));
                if (contact) {
                    contactToEditId = contactIdToEdit; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    addContactModalTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç";
                    nameInput.value = contact.name || '';
                    phoneInput.value = contact.phone || '';
                    vkInput.value = contact.vk || '';
                    tgInput.value = contact.tg || '';
                    photoPreview.src = contact.photo || noPhotoUrl; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    if (contact.photo && contact.photo.startsWith('data:image')) {
                        photoFileName.textContent = "–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–º–µ–Ω—ã)";
                    } else if (contact.photo && contact.photo !== noPhotoUrl) {
                        // –ï—Å–ª–∏ —ç—Ç–æ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π example_contact.png)
                        photoFileName.textContent = "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ñ–æ—Ç–æ";
                    } else {
                        photoFileName.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
                    }
                     // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentPhotoDataUrl –∑–¥–µ—Å—å, –æ–Ω —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ –ù–û–í–û–ï —Ñ–æ—Ç–æ
                } else {
                    console.error("–ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω:", contactIdToEdit);
                    addContactModalTitle.textContent = "–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç"; // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–∫ –Ω–æ–≤—ã–π
                }
            } else {
                addContactModalTitle.textContent = "–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç"; // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
            }

            openModal(addContactModal); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            nameInput.focus(); // –°—Ç–∞–≤–∏–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∏–º–µ–Ω–∏
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Ñ–æ—Ç–æ
        photoInput.addEventListener('change', (event) => {
             const file = event.target.files[0];
             const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2 MB

             // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ DataURL
             currentPhotoDataUrl = null;
             photoPreview.src = noPhotoUrl; // –í—Ä–µ–º–µ–Ω–Ω–æ —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É
             photoFileName.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";

             if (file && file.type.startsWith('image/')) {
                if (file.size > MAX_FILE_SIZE) {
                     alert(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. ${MAX_FILE_SIZE / 1024 / 1024}MB). –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.`);
                     photoInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–ø—É—Ç
                     // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ –¥–æ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ (–µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏)
                     if (contactToEditId) {
                         const contact = contacts.find(c => String(c.id) === String(contactToEditId));
                         photoPreview.src = (contact && contact.photo) ? contact.photo : noPhotoUrl;
                         photoFileName.textContent = (contact && contact.photo && contact.photo.startsWith('data:image')) ? "–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (—Å—Ç–∞—Ä–æ–µ)" : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
                     }
                     return;
                 }

                 const reader = new FileReader();
                 reader.onload = (e) => {
                     currentPhotoDataUrl = e.target.result; // –°–æ—Ö—Ä–∞–Ω—è–µ–º DataURL
                     photoPreview.src = currentPhotoDataUrl; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                     photoFileName.textContent = file.name; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                 }
                 reader.onerror = (e) => {
                    console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:", e);
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
                     photoInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–ø—É—Ç
                     // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ –∫–∞–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Ä–∞–∑–º–µ—Ä–∞
                     if (contactToEditId) {
                         const contact = contacts.find(c => String(c.id) === String(contactToEditId));
                         photoPreview.src = (contact && contact.photo) ? contact.photo : noPhotoUrl;
                         photoFileName.textContent = (contact && contact.photo && contact.photo.startsWith('data:image')) ? "–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (—Å—Ç–∞—Ä–æ–µ)" : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
                     }
                 }
                 reader.readAsDataURL(file); // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ DataURL

             } else if (file) { // –ï—Å–ª–∏ —Ñ–∞–π–ª –≤—ã–±—Ä–∞–Ω, –Ω–æ —ç—Ç–æ –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                 alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, JPG, PNG, GIF).");
                 photoInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–ø—É—Ç
                 // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ –∫–∞–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Ä–∞–∑–º–µ—Ä–∞/—á—Ç–µ–Ω–∏—è
                 if (contactToEditId) {
                     const contact = contacts.find(c => String(c.id) === String(contactToEditId));
                     photoPreview.src = (contact && contact.photo) ? contact.photo : noPhotoUrl;
                     photoFileName.textContent = (contact && contact.photo && contact.photo.startsWith('data:image')) ? "–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (—Å—Ç–∞—Ä–æ–µ)" : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
                 }
             }
             // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω (–Ω–∞–∂–∞–ª–∏ "–û—Ç–º–µ–Ω–∞"), –∏–Ω–ø—É—Ç —Å–∞–º –æ—á–∏—Å—Ç–∏—Ç—Å—è,
             // –∏ –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ –¥–æ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ"
             else if (!file && contactToEditId) {
                 const contact = contacts.find(c => String(c.id) === String(contactToEditId));
                 photoPreview.src = (contact && contact.photo) ? contact.photo : noPhotoUrl;
                 photoFileName.textContent = (contact && contact.photo && contact.photo.startsWith('data:image')) ? "–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–º–µ–Ω—ã)" : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
             }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
        addContactForm.addEventListener('submit', (event) => {
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π
            const name = nameInput.value.trim();
            const phoneRaw = phoneInput.value.trim();
            const vkLink = vkInput.value.trim();
            const tgLinkRaw = tgInput.value.trim();
            let isValid = true;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            nameInput.classList.remove('invalid');
            phoneInput.classList.remove('invalid');
            vkInput.classList.remove('invalid');
            tgInput.classList.remove('invalid');

            if (!name) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞.");
                nameInput.classList.add('invalid');
                nameInput.focus();
                isValid = false;
                return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∏–º—è –Ω–µ –≤–≤–µ–¥–µ–Ω–æ
            }

            let phone = null;
            if (phoneRaw) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É (7 –∏–ª–∏ 8 –∏ 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ)
                if (!/^[78]\d{10}$/.test(phoneRaw.replace(/\D/g, ''))) {
                     alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ 11 —Ü–∏—Ñ—Ä, –Ω–∞—á–∏–Ω–∞—è —Å 7 –∏–ª–∏ 8.");
                     phoneInput.classList.add('invalid');
                     if (isValid) phoneInput.focus(); // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–µ –ø–æ–ª–µ
                     isValid = false;
                } else {
                    phone = phoneRaw.replace(/\D/g, ''); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
                }
            }

            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ URL –¥–ª—è VK (–¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å vk.com –∏–ª–∏ vk.me)
            if (vkLink && !(vkLink.includes('vk.com') || vkLink.includes('vk.me'))) {
                alert("–°—Å—ã–ª–∫–∞ VK –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –û–Ω–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å 'vk.com' –∏–ª–∏ 'vk.me'.");
                vkInput.classList.add('invalid');
                if (isValid) vkInput.focus();
                isValid = false;
            }
             // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ TG (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å @, http, https, t.me)
            if (tgLinkRaw && !(/^@|^(https?:\/\/)?t\.me\//.test(tgLinkRaw))) {
                 alert("–°—Å—ã–ª–∫–∞/–∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –î–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å @, http(s):// –∏–ª–∏ t.me/");
                 tgInput.classList.add('invalid');
                 if (isValid) tgInput.focus();
                 isValid = false;
             }


            if (!isValid) return; // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ç–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            let photoToSave = noPhotoUrl; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥–ª—É—à–∫–∞
            if (currentPhotoDataUrl) {
                 // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ù–û–í–û–ï —Ñ–æ—Ç–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                photoToSave = currentPhotoDataUrl;
            } else if (contactToEditId) {
                 // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∏ –ù–û–í–û–ì–û —Ñ–æ—Ç–æ –Ω–µ—Ç, –±–µ—Ä–µ–º –°–¢–ê–†–û–ï —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (–∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É, –µ—Å–ª–∏ –∏ —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ –±—ã–ª–æ)
                 const existingContact = contacts.find(c => String(c.id) === String(contactToEditId));
                 photoToSave = (existingContact && existingContact.photo) ? existingContact.photo : noPhotoUrl;
            }
            // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç –∏ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –æ—Å—Ç–∞–Ω–µ—Ç—Å—è noPhotoUrl

            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞
            const contactData = {
                name: name,
                photo: photoToSave,
                phone: phone, // null, –µ—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–ª–∏ –Ω–µ –≤–≤–µ–¥–µ–Ω
                vk: vkLink || null, // null, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
                tg: tgLinkRaw || null // null, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
            };

            if (contactToEditId) {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∏—â–µ–º –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ ID –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                const index = contacts.findIndex(c => String(c.id) === String(contactToEditId));
                if (index > -1) {
                    contacts[index] = { ...contacts[index], ...contactData }; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
                } else {
                     console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ ID:", contactToEditId);
                     // –í –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π, –Ω–æ —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å
                     contacts.push({ id: `new-${Date.now()}-${Math.random()}`, ...contactData });
                }
            } else {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
                const newContact = {
                    id: `id-${Date.now()}-${Math.random().toString(16).slice(2)}`, // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                    ...contactData
                };
                contacts.push(newContact);
            }

            saveToStorage(CONTACTS_STORAGE_KEY, contacts); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ localStorage
            renderContacts(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            closeModal(addContactModal); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        });

        // --- –õ–æ–≥–∏–∫–∞ –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –û–∫–Ω–∞ –ó–∞–ø—Ä–æ—Å–∞ –°—É–º–º—ã ---
        function resetAmountRequestForm() {
            amountRequestForm.reset(); // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            amountInput.classList.remove('invalid'); // –£–±—Ä–∞—Ç—å —Å—Ç–∏–ª—å –æ—à–∏–±–∫–∏
            amountErrorMessage.style.display = 'none'; // –°–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            delete amountRequestForm.dataset.contactId; // –£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID –∫–æ–Ω—Ç–∞–∫—Ç–∞
            delete amountRequestForm.dataset.requestType; // –£–¥–∞–ª–∏—Ç—å —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
            amountRequestInfo.querySelector('b:first-of-type').textContent = ''; // –û—á–∏—Å—Ç–∏—Ç—å –∏–º—è
            amountRequestInfo.querySelector('b:last-of-type').textContent = ''; // –û—á–∏—Å—Ç–∏—Ç—å —Ç–∏–ø
        }

        function showAmountRequestModal(contact, requestType) {
            resetAmountRequestForm(); // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–æ—Å
            amountRequestForm.dataset.contactId = contact.id;
            amountRequestForm.dataset.requestType = requestType;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ
            const contactNameEl = amountRequestInfo.querySelector('b:first-of-type');
            const requestTypeEl = amountRequestInfo.querySelector('b:last-of-type');
            contactNameEl.textContent = contact.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
            requestTypeEl.textContent = requestType.toUpperCase(); // VK –∏–ª–∏ TG

            openModal(amountRequestModal); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            amountInput.focus(); // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ —Å—É–º–º—ã
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å—É–º–º—ã
        amountRequestForm.addEventListener('submit', (event) => {
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
            amountInput.classList.remove('invalid');
            amountErrorMessage.style.display = 'none';

            const amountRaw = amountInput.value;
            // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –∏ –ø–∞—Ä—Å–∏–º –∫–∞–∫ —á–∏—Å–ª–æ
            const amount = parseFloat(amountRaw.replace(',', '.'));

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã
            if (isNaN(amount) || amount <= 0) {
                amountInput.classList.add('invalid');
                amountErrorMessage.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                amountInput.focus();
                return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
            }

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏ —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Ñ–æ—Ä–º—ã
            const contactId = amountRequestForm.dataset.contactId;
            const requestType = amountRequestForm.dataset.requestType;
            const contact = contacts.find(c => String(c.id) === contactId);

            if (!contact || !requestType) {
                console.error("–ù–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.");
                alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
                closeModal(amountRequestModal);
                return;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
            let requestUrl = '#'; // URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            let historyType = ''; // –¢–∏–ø –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—É–º–º—É –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
            const amountFormattedForMessage = amount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' });
            const message = `–ü—Ä–∏–≤–µ—Ç! –ö–∞–∂–µ—Ç—Å—è, —Ç–≤–æ—è —á–∞—Å—Ç—å –∑–∞ –Ω–µ–¥–∞–≤–Ω–∏–µ –ø–æ—Å–∏–¥–µ–ª–∫–∏: ${amountFormattedForMessage}. –°–ø–∞—Å–∏–±–æ! üòä`;
            const encodedMessage = encodeURIComponent(message);

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
            if (requestType === 'vk' && contact.vk) {
                historyType = 'request_vk';
                requestUrl = generateVkLink(contact.vk, encodedMessage);
            } else if (requestType === 'tg' && contact.tg) {
                historyType = 'request_tg';
                requestUrl = generateTgLink(contact.tg, encodedMessage);
            } else {
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è ${requestType.toUpperCase()}, —Ç–∞–∫ –∫–∞–∫ —Å—Å—ã–ª–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ —É –∫–æ–Ω—Ç–∞–∫—Ç–∞ "${contact.name}".`);
                closeModal(amountRequestModal);
                return;
            }

            console.log("Generated URL:", requestUrl); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

            // --- –ü–æ–ø—ã—Ç–∫–∞ –æ–±–æ–π—Ç–∏ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ —á–µ—Ä–µ–∑ —Å–∏–º—É–ª—è—Ü–∏—é –∫–ª–∏–∫–∞ –ø–æ —Å—Å—ã–ª–∫–µ ---
            try {
                const link = document.createElement('a');
                link.href = requestUrl;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                // link.style.display = 'none'; // –°—Å—ã–ª–∫–∞ –Ω–µ–≤–∏–¥–∏–º–∞
                document.body.appendChild(link); // –í—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                link.click(); // –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫
                document.body.removeChild(link); // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É
                console.log("–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ link.click() –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.");
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ link.click():", error);
                // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É. –í–æ–∑–º–æ–∂–Ω–æ, –±—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∞.");
            }
            // --- –ö–æ–Ω–µ—Ü –ø–æ–ø—ã—Ç–∫–∏ –æ–±—Ö–æ–¥–∞ ---
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
            addHistoryEntry(historyType, contact, amount);
            closeModal(amountRequestModal); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        });

         // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫ ---
         function generateVkLink(vkInput, encodedMessage) {
            const vkLink = vkInput.trim();
             // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å ID –∏–ª–∏ username
            if (vkLink.includes('vk.com/id')) {
                const userId = vkLink.split('id')[1]?.match(/\d+/)?.[0];
                if (userId) return `https://vk.com/im?sel=${userId}&msg=${encodedMessage}`;
            } else if (vkLink.includes('vk.com/')) {
                const username = vkLink.split('vk.com/')[1]?.split('/')[0]?.split('?')[0];
                if (username && !username.includes('id') && username !== "im") { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ id –∏ –Ω–µ —Å—Å—ã–ª–∫–∞ –Ω–∞ im
                     return `https://vk.me/${username}?message=${encodedMessage}`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º vk.me –¥–ª—è username
                }
            } else if (vkLink.startsWith('vk.me/')) {
                 const username = vkLink.split('vk.me/')[1]?.split('/')[0]?.split('?')[0];
                 if (username) return `https://vk.me/${username}?message=${encodedMessage}`;
            }
            // Fallback: –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∏–ª–∏ —Å—Å—ã–ª–∫–∞ —Å—Ç—Ä–∞–Ω–Ω–∞—è, –ø—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å msg
            return `${vkLink}${vkLink.includes('?') ? '&' : '?'}msg=${encodedMessage}`;
        }

        function generateTgLink(tgInput, encodedMessage) {
            const tgLink = tgInput.trim();
            // –£–±–∏—Ä–∞–µ–º @, http(s)://, t.me/ –∏ –≤—Å–µ –ø–æ—Å–ª–µ ?
            const usernameOrLink = tgLink.replace(/^@/, '').replace(/^(https?:\/\/)?(www\.)?t\.me\//, '').split('?')[0];
            return `https://t.me/${usernameOrLink}?text=${encodedMessage}`;
        }


        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –û—Å–Ω–æ–≤–Ω—ã—Ö –ö–Ω–æ–ø–æ–∫ –∏ –≠–ª–µ–º–µ–Ω—Ç–æ–≤ ---

        // –ö–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏–ª–∏ –µ—ë —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
        contactListContainer.addEventListener('click', (event) => {
            const card = event.target.closest('.contact-card');
            if (!card) return; // –ö–ª–∏–∫ –≤–Ω–µ –∫–∞—Ä—Ç–æ—á–∫–∏

            const contactId = card.dataset.contactId;
            const contact = contacts.find(c => String(c.id) === contactId);
            if (!contact) return; // –ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ)

            const deleteBtn = event.target.closest('.delete-button');
            const requestBtn = event.target.closest('.vk-request-btn, .tg-request-btn');
            const editBtn = event.target.closest('.edit-button'); // –ï—Å–ª–∏ –±—É–¥–µ—Ç –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

            if (deleteBtn) {
                event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                 if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç "${contact.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}"?`)) {
                     contacts = contacts.filter(c => String(c.id) !== contactId);
                     saveToStorage(CONTACTS_STORAGE_KEY, contacts);
                     renderContacts(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫
                 }
                 return; // –í—ã–π—Ç–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏
            }

            if (requestBtn) {
                event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                const requestType = requestBtn.dataset.type; // 'vk' –∏–ª–∏ 'tg'
                showAmountRequestModal(contact, requestType); // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –∑–∞–ø—Ä–æ—Å–∞
                return; // –í—ã–π—Ç–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏
            }

            if (editBtn) {
                event.stopPropagation();
                showAddContactModal(contactId); // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                return;
            }

            // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ, –∞ –ø–æ —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å active
            const wasActive = card.classList.contains('active');
            // –°–Ω–∞—á–∞–ª–∞ —É–±–∏—Ä–∞–µ–º active —Å–æ –≤—Å–µ—Ö –¥—Ä—É–≥–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
             contactListContainer.querySelectorAll('.contact-card.active').forEach(activeCard => {
                 if (activeCard !== card) {
                     activeCard.classList.remove('active');
                 }
             });
            // –ó–∞—Ç–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å –Ω–∞ —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ
            card.classList.toggle('active', !wasActive);
        });

        // –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç"
        addContactButton.addEventListener('click', () => showAddContactModal());

        // –ö–Ω–æ–ø–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π"
        historyButton.addEventListener('click', () => {
            renderHistory(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
            openModal(historyModal);
        });

        // –ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
        clearHistoryButton.addEventListener('click', () => {
            if (transferHistory.length > 0 && confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) {
                transferHistory = []; // –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Å—Å–∏–≤ –≤ –ø–∞–º—è—Ç–∏
                localStorage.removeItem(HISTORY_STORAGE_KEY); // –£–¥–∞–ª–∏—Ç—å –∏–∑ localStorage
                renderHistory(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ø–æ–∫–∞–∂–µ—Ç "–ø—É—Å—Ç–æ" –∏ –≤—ã–∫–ª—é—á–∏—Ç –∫–Ω–æ–ø–∫—É)
            }
        });

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ó–∞–∫—Ä—ã—Ç–∏—è –ú–æ–¥–∞–ª—å–Ω—ã—Ö –û–∫–æ–Ω ---

        // –ö–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å" (–∫—Ä–µ—Å—Ç–∏–∫)
        modalCloseHistoryButton.addEventListener('click', () => closeModal(historyModal));
        modalCloseAddButton.addEventListener('click', () => closeModal(addContactModal));
        modalCloseAmountButton.addEventListener('click', () => closeModal(amountRequestModal));

        // –ö–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞"
        cancelAddButton.addEventListener('click', () => closeModal(addContactModal));
        cancelAmountButton.addEventListener('click', () => closeModal(amountRequestModal));

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π (—Ñ–æ–Ω –º–æ–¥–∞–ª–∫–∏)
        [historyModal, addContactModal, amountRequestModal].forEach(modal => {
            modal.addEventListener('click', (event) => {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–æ –æ–≤–µ—Ä–ª–µ—é
                if (event.target === modal) {
                    closeModal(modal);
                }
            });
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–ª–∞–≤–∏—à–∏ Escape
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (historyModal.classList.contains('visible')) closeModal(historyModal);
                if (addContactModal.classList.contains('visible')) closeModal(addContactModal);
                if (amountRequestModal.classList.contains('visible')) closeModal(amountRequestModal);
            }
        });

        // --- –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ü—Ä–∏ –ó–∞–≥—Ä—É–∑–∫–µ –°—Ç—Ä–∞–Ω–∏—Ü—ã ---
        window.addEventListener('load', renderContacts);

    </script>

</body>
</html>