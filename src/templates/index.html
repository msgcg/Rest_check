<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ПоДЕЛИ!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body> <!-- Класс results-shown будет добавляться/удаляться сюда -->
    <!-- Status Indicator Moved Outside Container -->
    <div id="status" class="status"></div>

    <!-- Хедер находится ПЕРЕД контейнером -->
    <div class="header index-header">
        <div class="logo">ПоДЕЛИ!</div>
        <div>Загрузите чек для разделения суммы</div>
    </div>

    <!-- Основной контейнер -->
    <div class="container">
        <div class="container-content">
            <!-- Preview Area -->
            <div class="image-preview-wrapper" id="preview-wrapper">
                <img id="preview">
            </div>

            <!-- Result Area Wrapper -->
            <div class="result-container" id="result-container">
                 <div id="result" class="result"></div>
                 <!-- Buttons/Menu inserted by JS -->
            </div>

            <!-- Input Wrapper -->
            <div class="input-wrapper">
                 <input type="file" id="image-input" accept="image/*" onchange="previewImage()">
                 <div class="input-container">
                     <input type="number" id="num-people-input" placeholder="Количество людей" required min="1" oninput="toggleUploadButton()">
                 </div>
                 <div class="input-container">
                     <input type="text" id="tip-amount-input" class="numeric-input" placeholder="Сумма чаевых" inputmode="decimal">
                 </div>
                 <div class="file-btn-wrapper">
                     <button id="upload-btn" onclick="upload_receipt()" disabled>Обработать изображение</button>
                 </div>
            </div>

            <!-- Filters -->
            <div class="filters" id="filters-wrapper">
               <button onclick="filter_recommendations('equally')">Поровну</button>
               <button onclick="filter_recommendations('who_more_eat_then_more_pay')">Кто больше ел</button>
               <button onclick="filter_recommendations('who_more_cost_then_more_pay')">Кто больше заплатил</button>
               <button onclick="filter_recommendations('proportional_division_by_the_cost_of_orders')">Пропорционально</button>
            </div>
        </div> <!-- Конец .container-content -->
    </div> <!-- End .container -->

    <script>
        let recommendations = {};

        // --- DOM Elements ---
        const previewWrapper = document.getElementById('preview-wrapper');
        const previewElement = document.getElementById('preview');
        const statusElement = document.getElementById('status');
        const resultContainer = document.getElementById('result-container');
        const resultElement = document.getElementById('result');
        const filtersWrapper = document.getElementById('filters-wrapper');
        const uploadButton = document.getElementById('upload-btn');
        const imageInput = document.getElementById('image-input');
        const numPeopleInput = document.getElementById('num-people-input');
        const tipAmountInput = document.getElementById('tip-amount-input');
        const containerElement = document.querySelector('.container');
        // <<< ИСПРАВЛЕНО: Присваиваем результат переменной >>>
        const containerContentElement = document.querySelector('.container-content');
        const headerElement = document.querySelector('.index-header'); // Получаем хедер

        // --- Tip Input Formatting ---
        function formatTipInput(inputElement) { let v=inputElement.value, n=v.replace(/[^0-9.,]/g,'').replace('₽','').replace(',','.'); const p=n.split('.'); if(p.length>2) n=p[0]+'.'+p.slice(1).join(''); if(n.length>1&&n.startsWith('0')&&!n.startsWith('0.')) n=n.substring(1); if(n==='.'||n===''){inputElement.value=''; return '';} const num=parseFloat(n); if(isNaN(num)||num<0){inputElement.value=''; return '';} inputElement.value=n+'₽'; return n; }
        function removeFormatting(inputElement) { inputElement.value = inputElement.value.replace('₽','').trim(); }
        tipAmountInput.addEventListener('focus', () => { removeFormatting(tipAmountInput); setTimeout(() => { tipAmountInput.setSelectionRange(tipAmountInput.value.length, tipAmountInput.value.length); }, 0); });
        tipAmountInput.addEventListener('blur', () => { formatTipInput(tipAmountInput); });
        tipAmountInput.addEventListener('input', () => { let c=tipAmountInput.selectionStart, o=tipAmountInput.value, v=o.replace(/[^0-9.,]/g,'').replace(',','.'); const p=v.split('.'); if(p.length>2)v=p[0]+'.'+p.slice(1).join(''); if(v.length>1&&v.startsWith('0')&&!v.startsWith('0.')){v=v.substring(1); if(c>0)c--;} if(v!==o.replace('₽','').trim()){tipAmountInput.value=v; try{tipAmountInput.setSelectionRange(c,c);}catch(e){console.warn("Cursor err:",e);}} });

        // --- Core App Functions ---
        function previewImage() {
            const file = imageInput.files[0];
            hideShareMenu();
            resultContainer.style.display = 'none';
            resultElement.innerHTML = '';
            filtersWrapper.style.display = 'none';
            statusElement.style.display = 'none';
            // <<< Управляем классом на body >>>
            document.body.classList.remove('results-shown');

            if (file) {
                previewElement.src = URL.createObjectURL(file);
                previewElement.style.display = 'block';
                previewWrapper.style.display = 'flex';
                containerElement.scrollTop = 0;
            } else {
                 previewElement.style.display = 'none';
                 previewWrapper.style.display = 'none';
            }
            toggleUploadButton();
        }

        function toggleUploadButton() {
            const numPeopleValid = numPeopleInput.value && parseInt(numPeopleInput.value, 10) > 0;
            uploadButton.disabled = !(numPeopleValid && imageInput.files.length > 0);
        }

        function formatOutputText(text) {
            if (!text) return "";
            return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        }

        function getResultTextForSharing() { /* ... без изменений ... */
            const resultDiv = document.getElementById('result');
            if (!resultDiv) return "";
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = resultDiv.innerHTML;
            tempDiv.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
            let text = tempDiv.innerText || tempDiv.textContent || "";
            return text.trim();
        }
        async function copyResultText() { /* ... без изменений ... */
            const copyButton = document.getElementById('copy-result-btn');
            if (!copyButton) return;
            const textToCopy = getResultTextForSharing();
            if (!textToCopy) { console.warn("No text to copy."); return; }
            try {
                await navigator.clipboard.writeText(textToCopy);
                const originalIcon = copyButton.innerHTML;
                copyButton.innerHTML = '✅'; copyButton.title = 'Скопировано!'; copyButton.style.color = '#08a552';
                setTimeout(() => { if(document.getElementById('copy-result-btn')) { document.getElementById('copy-result-btn').innerHTML = originalIcon; document.getElementById('copy-result-btn').title = 'Скопировать результат'; document.getElementById('copy-result-btn').style.color = ''; } }, 1500);
            } catch (err) {
                console.error('Ошибка копирования: ', err); alert('Не удалось скопировать текст.');
                 const originalIcon = copyButton.innerHTML; copyButton.innerHTML = '❌'; copyButton.title = 'Ошибка копирования'; copyButton.style.color = '#cb0001';
                 setTimeout(() => { if(document.getElementById('copy-result-btn')) { document.getElementById('copy-result-btn').innerHTML = originalIcon; document.getElementById('copy-result-btn').title = 'Скопировать результат'; document.getElementById('copy-result-btn').style.color = ''; } }, 2000);
            }
             hideShareMenu();
        }
        function toggleShareMenu() { /* ... без изменений ... */
             const menu = document.getElementById('share-menu');
             if (menu) { menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; }
         }
        function hideShareMenu() { /* ... без изменений ... */
             const menu = document.getElementById('share-menu'); if (menu) { menu.style.display = 'none'; }
         }
        function shareViaVK() { /* ... без изменений ... */
            const description = getResultTextForSharing();
            const title = "ПоДЕЛИ! - Результат деления";
            console.log("Sharing to VK - Title:", title);
            console.log("Sharing to VK - Description/Comment:", description);
            if (!description) { console.warn("No result text available for VK sharing description."); }
            const shareUrl = `https://vk.com/share.php?title=${encodeURIComponent(title)}&comment=${encodeURIComponent(description)}`;
            console.log("VK Share URL:", shareUrl);
            window.open(shareUrl, '_blank', 'noopener,noreferrer');
            hideShareMenu();
        }
        function shareViaTelegram() { /* ... без изменений ... */
            const textToShare = getResultTextForSharing();
            console.log("Sharing to Telegram - Text:", textToShare);
             if (!textToShare) { console.warn("No text available for Telegram sharing."); return; }
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent('Привет! ')}&text=${encodeURIComponent('Обратите внимание, текст обрезан для лимитов браузера: ') + encodeURIComponent(textToShare.substring(0, 700))}`;
            console.log("Telegram Share URL:", shareUrl);
            window.open(shareUrl, '_blank', 'noopener,noreferrer');
            hideShareMenu();
        }
        function shareViaSMS() { /* ... без изменений ... */
            const text = getResultTextForSharing();
            console.log("Sharing via SMS - Text:", text);
             if (!text) { console.warn("No text available for SMS sharing."); return; }
            const body = text;
            console.log("SMS Body (encoded):", body);
            window.location.href = `sms:?body=${body}`;
        }
        document.addEventListener('click', function(event) { /* ... без изменений ... */
            const menu = document.getElementById('share-menu');
            const shareButton = document.getElementById('share-result-btn');
            if (menu && menu.style.display === 'block' && !menu.contains(event.target) && shareButton && !shareButton.contains(event.target)) {
                hideShareMenu();
            }
        });

        const svgIconCopy = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`;
        const svgIconShare = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>`;
        const svgIconVK = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.07 2H8.93C3.33 2 2 3.33 2 8.93V15.07C2 20.67 3.33 22 8.93 22H15.07C20.67 22 22 20.67 22 15.07V8.93C22 3.33 20.67 2 15.07 2M18.15 16.27H16.69C16.14 16.27 15.97 15.82 15 14.83C14.12 13.94 13.74 13.71 13.53 13.71C13.24 13.71 13.15 13.83 13.15 14.38V15.69C13.15 16.04 13.04 16.26 12.11 16.26C10.57 16.26 8.86 15.32 7.66 13.59C5.85 11.05 5.36 9.13 5.36 8.75C5.36 8.54 5.43 8.34 5.85 8.34H7.32C7.69 8.34 7.83 8.5 7.97 8.9C8.69 11 9.89 12.8 10.38 12.8C10.57 12.8 10.65 12.71 10.65 12.25V10.1C10.6 9.12 10.07 9.03 10.07 8.68C10.07 8.5 10.21 8.34 10.44 8.34H12.73C13.04 8.34 13.15 8.5 13.15 8.88V11.77C13.15 12.08 13.28 12.19 13.38 12.19C13.56 12.19 13.72 12.08 14.05 11.74C15.1 10.57 15.85 8.76 15.85 8.76C15.95 8.55 16.11 8.35 16.5 8.35H17.93C18.37 8.35 18.47 8.58 18.37 8.89C18.19 9.74 16.41 12.25 16.43 12.25C16.27 12.5 16.21 12.61 16.43 12.9C16.58 13.11 17.09 13.55 17.43 13.94C18.05 14.65 18.53 15.24 18.66 15.65C18.77 16.06 18.57 16.27 18.15 16.27Z"/></svg>`;
        const svgIconTelegram = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9.78,18.65L10.06,14.42L17.74,7.5C18.08,7.19 17.67,7.04 17.22,7.31L7.74,13.3L3.64,12C2.76,11.75 2.75,11.14 3.84,10.7L19.81,4.54C20.54,4.21 21.24,4.72 20.96,5.84L18.24,18.65C18.05,19.56 17.5,19.78 16.74,19.36L12.6,16.3L10.61,18.23C10.38,18.46 10.19,18.65 9.78,18.65Z"/></svg>`;
        const svgIconSMS = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>`;

        function displayRecommendations(filterType = 'equally') { /* ... без изменений ... */
             let textToShow = "";
             switch (filterType) {
                 case 'equally': textToShow = recommendations.equally; break;
                 case 'who_more_eat_then_more_pay': textToShow = recommendations.who_more_eat_then_more_pay; break;
                 case 'who_more_cost_then_more_pay': textToShow = recommendations.who_more_cost_then_more_pay; break;
                 case 'proportional_division_by_the_cost_of_orders': textToShow = recommendations.proportional_division_by_the_cost_of_orders; break;
                 default: textToShow = recommendations.equally;
             }
             resultElement.innerHTML = '';
             resultContainer.style.display = "block";
             const oldButtons = resultContainer.querySelectorAll('.result-action-btn, #share-menu');
             oldButtons.forEach(btn => btn.remove());
             const buttonsAndMenuHTML = `
                 <button id="copy-result-btn" class="result-action-btn" title="Скопировать результат" onclick="copyResultText()">${svgIconCopy}</button>
                 <button id="share-result-btn" class="result-action-btn" title="Поделиться" onclick="toggleShareMenu()">${svgIconShare}</button>
                 <div id="share-menu">
                     <a href="#" onclick="shareViaVK(); return false;">${svgIconVK}<span>ВКонтакте</span></a>
                     <a href="#" onclick="shareViaTelegram(); return false;">${svgIconTelegram}<span>Telegram</span></a>
                     <a href="#" onclick="shareViaSMS(); return false;">${svgIconSMS}<span>SMS</span></a>
                 </div>`;
             resultElement.insertAdjacentHTML('afterend', buttonsAndMenuHTML);
             resultElement.innerHTML = formatOutputText(textToShow || "Рекомендации не найдены.");
             hideShareMenu();
        }

        function filter_recommendations(filterType) { /* ... без изменений ... */
             if (!recommendations || Object.keys(recommendations).length === 0) { return; }
            displayRecommendations(filterType);
            resultElement.scrollTop = 0;
        }

        async function upload_receipt() {
            const file = imageInput.files[0];
            const numPeople = numPeopleInput.value;
            let tipString = tipAmountInput.value.replace('₽','').trim().replace(',','.');
            const tipAmount = parseFloat(tipString) || 0;

            if (!file || !numPeople || parseInt(numPeople, 10) <= 0) { alert("Пожалуйста, выберите изображение чека и укажите корректное количество людей (> 0)."); return; }
            if (tipAmount < 0) { alert("Сумма чаевых не может быть отрицательной."); tipAmountInput.value = ''; tipAmountInput.focus(); return; }

            uploadButton.disabled = true;
            previewWrapper.style.display = 'none';
            resultContainer.style.display = 'none';
            resultElement.innerHTML = '';
            filtersWrapper.style.display = 'none';
            hideShareMenu();
            // <<< Управляем классом на body >>>
            document.body.classList.remove('results-shown');

            statusElement.textContent = "Обработка...";
            statusElement.className = 'status processing';
            statusElement.style.display = 'block';

            const formData = new FormData();
            formData.append("receipt_image", file);
            formData.append("num_people", numPeople);
            formData.append("tea_money", tipAmount);

            let statusTimer = null;

            try {
                const response = await fetch('/upload_receipt', { method: "POST", body: formData });
                clearTimeout(statusTimer);

                if (!response.ok) {
                    let errorMsg = `Ошибка ${response.status}`;
                    try { const errorData = await response.json(); errorMsg = errorData.detail || errorData.message || errorMsg; } catch (e) { errorMsg = `Ошибка ${response.status}: ${response.statusText}`; }
                    statusElement.textContent = errorMsg;
                    statusElement.className = 'status error';
                    statusElement.style.display = 'block';
                    // <<< Управляем классом на body >>>
                    document.body.classList.remove('results-shown');
                    throw new Error(errorMsg);
                }

                const responseData = await response.json();
                console.log("Получены данные:", responseData);

                if (responseData.is_restaurant === true) {
                    recommendations = responseData;
                    statusElement.textContent = "Обработка завершена!";
                    statusElement.className = 'status success';
                    statusElement.style.display = 'block';
                    statusTimer = setTimeout(() => { statusElement.style.display = 'none'; }, 1800);
                    // <<< Управляем классом на body >>>
                    document.body.classList.add('results-shown');

                    displayRecommendations('equally');
                    filtersWrapper.style.display = "flex";

                    setTimeout(() => {
                         containerElement.scrollTo({ top: containerElement.scrollHeight, behavior: 'smooth' });
                     }, 100);

                } else {
                    const errorText = "Ошибка: Загруженное изображение не похоже на чек из ресторана.";
                    statusElement.textContent = errorText;
                    statusElement.className = 'status error';
                    statusElement.style.display = 'block';
                    recommendations = {};
                    resultContainer.style.display = "none";
                    filtersWrapper.style.display = "none"; hideShareMenu();
                    // <<< Управляем классом на body >>>
                    document.body.classList.remove('results-shown');
                }

            } catch (error) {
                console.error("Ошибка при обработке чека:", error);
                clearTimeout(statusTimer);
                 if (statusElement.style.display === 'none' || !statusElement.classList.contains('error')) {
                    statusElement.textContent = `Ошибка: ${error.message || "Не удалось обработать чек"}`;
                    statusElement.className = 'status error';
                    statusElement.style.display = 'block';
                 }
                recommendations = {};
                resultContainer.style.display = "none";
                filtersWrapper.style.display = "none"; hideShareMenu();
                // <<< Управляем классом на body >>>
                document.body.classList.remove('results-shown');
            } finally {
                toggleUploadButton();
            }
        }

        window.onload = () => { /* ... без изменений ... */
             toggleUploadButton();
             hideShareMenu();
             if (tipAmountInput.value) { formatTipInput(tipAmountInput); }
             document.body.addEventListener('click', (event) => {
                 if (statusElement.style.display !== 'none' && !statusElement.contains(event.target)) {
                    const isProcessing = statusElement.classList.contains('processing');
                    const clickedUpload = uploadButton.contains(event.target);
                     if (!(isProcessing && clickedUpload)) { statusElement.style.display = 'none'; }
                 }
             }, true);
        };
    </script>

</body>
</html>