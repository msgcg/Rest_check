<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ПоДЕЛИ!</title>
    <style>
        /* --- Global Styles & Body --- */
        html, body {
            height: 100%; margin: 0; padding: 0;
        }
        body {
            font-family: Arial, sans-serif;
            background-size: cover; background-repeat: no-repeat;
            background-attachment: fixed; background-position: center center;
            background-color: #f0f0f0; color: #000000;
            display: flex;
            align-items: flex-end; /* Align container to the bottom */
            justify-content: center; /* Center container horizontally */
            min-height: 100%;
            padding-bottom: 20px; /* Space below the container */
            box-sizing: border-box;
            position: relative;
        }
        /* Background Image Style */
        body {
             background-image: url("{{ url_for('static', filename='images/splash.png') }}"); /* Adjust path if needed */
             background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed;
        }

        /* --- Main Container --- */
        .container {
            width: 90%; max-width: 600px;
            background-color: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            max-height: calc(100vh - 60px); /* Limit height */
            overflow-y: auto; /* Allow scrolling INSIDE container */
            display: flex; flex-direction: column; /* Stack elements vertically */
            border: 4px solid transparent; background-clip: padding-box;
            border-image: linear-gradient(45deg, #08a552, #9fe61f) 1;
            position: relative;
        }
        h1 { color: #08a552; text-align: center; margin-top: 0; margin-bottom: 15px; font-weight: bold; flex-shrink: 0; }

        /* --- Status Indicator (Fixed Overlay) --- */
        #status {
            display: none; /* Hidden by default */
            position: fixed; /* Position relative to viewport */
            top: 65%; /* MOVED LOWER */
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em; font-weight: bold;
            color: #08a552; /* Default color */
            text-align: center;
            padding: 25px 30px; /* More padding */
            background-color: rgba(255, 255, 255, 0.97); /* More opaque */
            border-radius: 12px;
            z-index: 1000; /* High z-index to be on top */
            border: 3px solid #08a552; /* Default border */
            width: 80%; /* Responsive width */
            max-width: 400px; /* Max width */
            box-sizing: border-box;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); /* Add shadow */
        }
        #status.processing { animation: pulsate 1.5s infinite ease-in-out; border-color: #08a552; color: #08a552; }
        #status.error { color: #cb0001; border-color: #cb0001; animation: none; }
        #status.success { color: #08a552; border-color: #08a552; animation: none; }
        @keyframes pulsate { 0% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.03); } 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); } }

        /* --- Content Blocks (Preview & Result Wrapper) --- */
        .image-preview-wrapper {
            display: none; /* Hidden initially */
            flex-direction: column; align-items: center; justify-content: center;
            margin-top: 15px; margin-bottom: 15px;
            width: 100%; align-self: center;
            max-width: 90%; min-height: 100px;
        }
        #preview { max-width: 100%; max-height: 250px; height: auto; border-radius: 10px; margin-top: 10px; border: 1px solid #ddd; }

        /* --- Result Area Wrapper (NEW) --- */
        .result-container {
            display: none; /* Hidden initially, shown by JS */
            position: relative; /* Context for absolute buttons/menu */
            width: 100%; /* Takes available width */
            max-width: 550px; /* Match #result max-width */
            align-self: center;
            margin-top: 15px; margin-bottom: 15px; /* Spacing */
            padding-bottom: 45px; /* Space BELOW #result for buttons */
            box-sizing: border-box;
        }

        #result {
            /* display: block; /* Always visible INSIDE the wrapper when wrapper is shown */
            /* margin: 0; /* Removed margin, handled by wrapper */
            padding: 15px; /* Original padding */
            /* padding-bottom: 55px; /* REMOVED - Now handled by wrapper */
            background-color: #f8fdfa; border-radius: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            width: 100%; /* Full width of wrapper */
            box-sizing: border-box;
            white-space: pre-wrap; line-height: 1.6; text-align: left; color: #000000; border: 2px solid transparent;
            background-clip: padding-box; border-image: linear-gradient(to right, #e0f0e8, #f0faf5) 1;
            /* position: relative; /* No longer needed for buttons */
            min-height: 100px; /* Minimum height */
            overflow-y: auto;  /* Enable vertical scroll if content overflows */
            max-height: 350px; /* Limit the maximum height of the result block */
        }
        #result b { color: #08a552; font-weight: bold; }

        /* --- Input Wrapper (Pushed Down) --- */
        .input-wrapper {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 300px; /* Consistent width */
            align-self: center; /* Center horizontally */
            margin-top: auto; /* <<< KEY: Pushes this block down */
            padding-top: 20px; /* Space above when pushed down */
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* --- File/Number/Tip Inputs (Inside Input Wrapper) --- */
        .file-input-gradient-border { width: 100%; padding: 3px; margin: 10px 0 5px 0; border-radius: 13px; background: linear-gradient(to right, #08a552, #9fe61f); box-sizing: border-box; }
        input[type="file"] { border: none; display: block; width: 100%; padding: 10px; box-sizing: border-box; font-size: 16px; color: #333; background-color: #ffffff; border-radius: 10px; overflow: hidden; }
        input[type="file"]::file-selector-button { padding: 10px 15px; margin-right: 10px; background-color: #08a552; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        input[type="file"]::file-selector-button:hover { background-color: #067d40; }
        input[type="number"], input[type="text"].numeric-input { padding: 12px 15px; border: 2px solid #ccc; border-radius: 10px; width: 100%; box-sizing: border-box; font-size: 16px; background-color: #fff; color: #333; margin: 5px 0; }
        input[type="number"] { -webkit-appearance: none; -moz-appearance: textfield; }
        input::placeholder { color: #aaa; opacity: 1; } input:-ms-input-placeholder { color: #aaa; } input::-ms-input-placeholder { color: #aaa; }
        .input-container { width: 100%; /* Occupy wrapper width */ }

        /* --- Upload Button (Inside Input Wrapper) --- */
        .file-btn-wrapper { margin-top: 10px; width: 100%; }
        button#upload-btn { padding: 12px 15px; background-color: #08a552; color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; transition: background-color 0.3s; box-sizing: border-box; }
        button#upload-btn:hover { background-color: #067d40; }
        button#upload-btn:disabled { background-color: #bdbdbd; color: #757575; cursor: not-allowed; border-image: none; }

        /* --- Filters (Follow Input Wrapper) --- */
        .filters {
             display: none; /* Hidden initially */
             flex-direction: column; /* Stack buttons vertically */
             align-items: stretch; /* Make buttons fill width */
             width: 100%; max-width: 300px; /* Match input wrapper width */
             margin-top: 15px; /* Space below upload button */
             align-self: center; /* Center horizontally */
             flex-shrink: 0; /* Prevent shrinking */
        }
        .filters button { margin: 4px 0; padding: 10px 12px; background-color: #e8f5e9; color: #08a552; border: 1px solid #a5d6a7; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background-color 0.3s, color 0.3s; box-sizing: border-box; text-align: center; }
        .filters button:hover { background-color: #c8e6c9; color: #067d40;}
        .filters button:disabled { background-color: #eeeeee; color: #9e9e9e; cursor: not-allowed; border-color: #e0e0e0;}

        /* --- Result Buttons/Menu (Positioned inside .result-container) --- */
        .result-action-btn {
            position: absolute; /* Relative to .result-container */
            bottom: 10px; /* Position near bottom of wrapper */
            z-index: 5; background-color: white; color: #555; cursor: pointer; padding: 5px; line-height: 1; border-radius: 8px; border: 2px solid transparent; border-image: linear-gradient(45deg, #08a552, #9fe61f) 1; background-clip: padding-box; width: auto; height: auto; font-weight: normal; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: color 0.2s, background-color 0.2s, box-shadow 0.2s; display: flex; align-items: center; justify-content: center;
         }
        .result-action-btn:hover { color: #08a552; background-color: #f0f0f0; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .result-action-btn:active { color: #067d40; background-color: #e0e0e0;}
        .result-action-btn svg { width: 18px; height: 18px; fill: currentColor; }
        #copy-result-btn { right: 50px; /* Position relative to wrapper */ }
        #share-result-btn { right: 10px; /* Position relative to wrapper */ }

        #share-menu {
            display: none;
            position: absolute; /* Relative to .result-container */
            bottom: 45px; /* Position *above* the share button */
            right: 10px;
            background-color: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            padding: 5px 0; /* Reduced padding */
            z-index: 11; min-width: 150px; overflow: visible; /* Allow content to overflow if needed, though shouldn't */
        }
        #share-menu a {
            display: flex; align-items: center;
            padding: 7px 15px; /* Reduced vertical padding */
            color: #333; text-decoration: none; font-size: 14px; white-space: nowrap; transition: background-color 0.2s, color 0.2s;
        }
        #share-menu a:hover { background-color: #f0f0f0; color: #08a552; }
        #share-menu a svg { width: 16px; /* Slightly smaller icon */ height: 16px; margin-right: 8px; fill: currentColor; flex-shrink: 0; }
        #share-menu a span { line-height: 1.2; /* Adjust line height if needed */ }

        /* --- Mobile Styles --- */
        @media (max-width: 600px) {
             body { padding-bottom: 10px; }
             .container { width: 95%; padding: 15px; margin-bottom: 5px; max-height: calc(100vh - 40px); }
             #status { font-size: 1.2em; width: 85%; padding: 20px; top: 75.4%; /* Adjust if needed */ }
             .input-wrapper { max-width: 90%; padding-top: 15px; }
             .filters { max-width: 90%; }
             .filters button { font-size: 13px; padding: 9px 10px;}

             .result-container { padding-bottom: 40px; } /* Less space for buttons on mobile */
             #result { max-width: 100%; /* Take full wrapper width */ padding: 10px; /* Adjust padding */ min-height: 80px; max-height: 300px; /* Adjusted max-height */ }

             input[type="number"], input[type="text"].numeric-input { font-size: 15px; padding: 10px 12px; }

             .result-action-btn { bottom: 8px; padding: 4px; border-width: 1px; border-radius: 6px; }
             .result-action-btn svg { width: 16px; height: 16px; }
             #copy-result-btn { right: 45px; }
             #share-result-btn { right: 8px; }

             #share-menu { bottom: 38px; /* Above mobile button */ right: 8px; min-width: 140px; box-shadow: 0 -3px 10px rgba(0,0,0,0.15); padding: 4px 0; }
             #share-menu a { padding: 6px 12px; /* Further reduced padding */ font-size: 13px;}
             #share-menu a svg { width: 15px; height: 15px; margin-right: 7px;}
        }
        /* Добавьте этот блок ВНУТРИ существующего тега <style> или в ваш CSS-файл */

        @media (prefers-color-scheme: dark) {

        /* --- Глобальные стили и Body --- */
        body {
            background-color: #000000; /* Чистый черный для AMOLED */
            color: #e0e0e0;       /* Светло-серый текст по умолчанию */
            /* Опционально: затемнить фоновое изображение для темной темы */
            /* background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url("{{ url_for('static', filename='images/splash.png') }}"); */
        }

        /* --- Основной контейнер --- */
        .container {
            background-color: #000000; /* Чистый черный */
            box-shadow: 0 4px 15px rgba(200, 200, 200, 0.1); /* Очень легкая тень для темного фона */
            border: 4px solid transparent; background-clip: padding-box;
            border-image: linear-gradient(45deg, #08a552, #9fe61f) 1;
        }
        h1 {
            color: #12c26a; /* Немного более яркий зеленый для контраста */
        }

        /* --- Индикатор статуса --- */
        #status {
            color: #12c26a; /* Яркий зеленый */
            background-color: rgba(25, 25, 25, 0.97); /* Очень темный полупрозрачный фон */
            border-color: #12c26a;
            box-shadow: 0 5px 20px rgba(200,200,200,0.1); /* Легкая тень */
        }
        #status.processing { border-color: #12c26a; color: #12c26a; }
        #status.error {
            color: #ff5555; /* Яркий красный */
            border-color: #ff5555;
        }
        #status.success { color: #12c26a; border-color: #12c26a; }

        /* --- Превью --- */
        #preview {
            border: 1px solid #444; /* Темно-серая рамка */
        }

        /* --- Область результата --- */
        .result-container {
            /* Стили контейнера не меняем, меняем #result внутри */
        }
        #result {
            background-color: #1a1a1a; /* Очень темный серый, чтобы отличался от фона body */
            color: #e0e0e0;       /* Светлый текст */
            box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.05); /* Легкая внутренняя тень */
            /* Убираем светлый градиент рамки */
            border: 2px solid #444;
            border-image: none;
        }
        #result b {
            color: #12c26a; /* Яркий зеленый */
        }

        /* --- Обертка инпутов --- */
        .input-wrapper {
            /* Стили не меняем */
        }

        /* --- Инпуты --- */
        .file-input-gradient-border {
            /* Меняем градиент на более подходящий для темной темы или убираем */
            background: linear-gradient(to right, #12c26a, #bfff30); /* Адаптированный градиент */
        }
        input[type="file"] {
            color: #e0e0e0; /* Светлый текст */
            background-color: #222; /* Темный фон инпута */
        }
        input[type="file"]::file-selector-button {
            /* Основные цвета кнопки могут остаться, контраст должен быть ок */
            /* background-color: #08a552; color: white; */
        }
        input[type="file"]::file-selector-button:hover {
            /* background-color: #067d40; */
        }
        input[type="number"], input[type="text"].numeric-input {
            background-color: #222; /* Темный фон */
            color: #e0e0e0; /* Светлый текст */
            border: 2px solid #555; /* Темно-серая рамка */
        }
        input::placeholder {
            color: #777; /* Более темный серый плейсхолдер */
        }

        /* --- Кнопка загрузки --- */
        button#upload-btn {
            /* Основные цвета могут остаться */
            /* background-color: #08a552; color: white; */
        }
        button#upload-btn:hover {
            /* background-color: #067d40; */
        }
        button#upload-btn:disabled {
            background-color: #444; /* Темно-серый фон для неактивной */
            color: #888; /* Серый текст для неактивной */
            border-image: none;
        }

        /* --- Фильтры --- */
        .filters button {
            background-color: #2a2a2a; /* Темный фон кнопок */
            color: #12c26a; /* Светло-зеленый текст */
            border: 1px solid #444; /* Темная рамка */
        }
        .filters button:hover {
            background-color: #383838; /* Чуть светлее при наведении */
            color: #30d070; /* Ярче зеленый при наведении */
        }
        .filters button:disabled {
            background-color: #333; /* Темный фон неактивной */
            color: #777; /* Серый текст неактивной */
            border-color: #555; /* Темная рамка неактивной */
        }

        /* --- Кнопки результата / Меню --- */
        .result-action-btn {
            background-color: #1a1a1a; /* Фон как у #result */
            color: #aaa; /* Светло-серый для иконок */
            border: 2px solid #555; /* Темная рамка */
            border-image: none;
            box-shadow: 0 1px 3px rgba(255,255,255,0.08); /* Легкая тень */
        }
        .result-action-btn:hover {
            color: #12c26a; /* Зеленый при наведении */
            background-color: #333; /* Темнее фон при наведении */
            box-shadow: 0 2px 5px rgba(255,255,255,0.12);
        }
        .result-action-btn:active {
            color: #067d40;
            background-color: #444;
        }
        /* SVG иконки наследуют цвет (currentColor) */

        #share-menu {
            background-color: #2a2a2a; /* Темный фон меню */
            border: 1px solid #555; /* Темная рамка */
            box-shadow: 0 -4px 12px rgba(255,255,255,0.1); /* Легкая тень */
        }
        #share-menu a {
            color: #e0e0e0; /* Светлый текст ссылок */
        }
        #share-menu a:hover {
            background-color: #383838; /* Темнее фон при наведении */
            color: #12c26a; /* Зеленый текст при наведении */
        }
        /* SVG иконки в меню наследуют цвет */

        } /* Конец @media (prefers-color-scheme: dark) */

</style>
    </style>
</head>
<body>
    <!-- Status Indicator Moved Outside Container for Fixed Positioning -->
    <div id="status" class="status"></div>

    <div class="container">
        <h1>ПоДЕЛИ!</h1>

        <!-- Preview Area -->
        <div class="image-preview-wrapper" id="preview-wrapper">
            <img id="preview">
        </div>

        <!-- Result Area Wrapper (Controls Button/Menu Positioning) -->
        <div class="result-container" id="result-container">
             <!-- Result Text Area (Scrollable) -->
             <div id="result" class="result">
                 <!-- Text inserted by JS -->
             </div>
             <!-- Buttons/Menu inserted here by JS -->
        </div>

        <!-- Input Wrapper (Pushed to bottom by margin-top: auto) -->
        <div class="input-wrapper">
             <div class="file-input-gradient-border">
                 <input type="file" id="image-input" accept="image/*" onchange="previewImage()">
             </div>
             <div class="input-container">
                 <input type="number" id="num-people-input" placeholder="Количество людей" required min="1" oninput="toggleUploadButton()">
             </div>
             <div class="input-container">
                 <input type="text" id="tip-amount-input" class="numeric-input" placeholder="Сумма чаевых" inputmode="decimal">
             </div>
             <div class="file-btn-wrapper">
                 <button id="upload-btn" onclick="upload_receipt()" disabled>Обработать изображение</button>
             </div>
        </div>

        <!-- Filters (Appear below Input Wrapper when visible) -->
        <div class="filters" id="filters-wrapper">
           <button onclick="filter_recommendations('equally')">Поровну</button>
           <button onclick="filter_recommendations('who_more_eat_then_more_pay')">Кто больше ел</button>
           <button onclick="filter_recommendations('who_more_cost_then_more_pay')">Кто больше заплатил</button>
           <button onclick="filter_recommendations('proportional_division_by_the_cost_of_orders')">Пропорционально</button>
        </div>

    </div> <!-- End .container -->

    <script>
        let recommendations = {};

        // --- DOM Elements ---
        const previewWrapper = document.getElementById('preview-wrapper');
        const previewElement = document.getElementById('preview');
        const statusElement = document.getElementById('status');
        const resultContainer = document.getElementById('result-container'); // Get the wrapper
        const resultElement = document.getElementById('result');            // Get the text area
        const filtersWrapper = document.getElementById('filters-wrapper');
        const uploadButton = document.getElementById('upload-btn');
        const imageInput = document.getElementById('image-input');
        const numPeopleInput = document.getElementById('num-people-input');
        const tipAmountInput = document.getElementById('tip-amount-input');
        const containerElement = document.querySelector('.container');

        // --- Tip Input Formatting (No changes) ---
        function formatTipInput(inputElement) { let v=inputElement.value, n=v.replace(/[^0-9.,]/g,'').replace('₽','').replace(',','.'); const p=n.split('.'); if(p.length>2) n=p[0]+'.'+p.slice(1).join(''); if(n.length>1&&n.startsWith('0')&&!n.startsWith('0.')) n=n.substring(1); if(n==='.'||n===''){inputElement.value=''; return '';} const num=parseFloat(n); if(isNaN(num)||num<0){inputElement.value=''; return '';} inputElement.value=n+'₽'; return n; }
        function removeFormatting(inputElement) { inputElement.value = inputElement.value.replace('₽','').trim(); }
        tipAmountInput.addEventListener('focus', () => { removeFormatting(tipAmountInput); setTimeout(() => { tipAmountInput.setSelectionRange(tipAmountInput.value.length, tipAmountInput.value.length); }, 0); });
        tipAmountInput.addEventListener('blur', () => { formatTipInput(tipAmountInput); });
        tipAmountInput.addEventListener('input', () => { let c=tipAmountInput.selectionStart, o=tipAmountInput.value, v=o.replace(/[^0-9.,]/g,'').replace(',','.'); const p=v.split('.'); if(p.length>2)v=p[0]+'.'+p.slice(1).join(''); if(v.length>1&&v.startsWith('0')&&!v.startsWith('0.')){v=v.substring(1); if(c>0)c--;} if(v!==o.replace('₽','').trim()){tipAmountInput.value=v; try{tipAmountInput.setSelectionRange(c,c);}catch(e){console.warn("Cursor err:",e);}} });

        // --- Core App Functions ---
        function previewImage() {
            const file = imageInput.files[0];
            hideShareMenu();
            resultContainer.style.display = 'none'; // Hide the whole result wrapper
            resultElement.innerHTML = '';           // Clear text area
            filtersWrapper.style.display = 'none';
            statusElement.style.display = 'none';

            if (file) {
                previewElement.src = URL.createObjectURL(file);
                previewElement.style.display = 'block';
                previewWrapper.style.display = 'flex';
                containerElement.scrollTop = 0; // Scroll container to top
            } else {
                 previewElement.style.display = 'none';
                 previewWrapper.style.display = 'none';
            }
            toggleUploadButton();
        }

        function toggleUploadButton() {
            const numPeopleValid = numPeopleInput.value && parseInt(numPeopleInput.value, 10) > 0;
            uploadButton.disabled = !(numPeopleValid && imageInput.files.length > 0);
        }

        function formatOutputText(text) {
            if (!text) return "";
            return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        }

        // --- Result Text Extraction for Sharing/Copying ---
        function getResultTextForSharing() {
            // Extract text ONLY from the #result div (which contains the text)
            const resultDiv = document.getElementById('result');
            if (!resultDiv) return "";
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = resultDiv.innerHTML; // Copy only the text part
            tempDiv.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
            let text = tempDiv.innerText || tempDiv.textContent || "";
            return text.trim();
        }

        // --- Copy Functionality (No changes) ---
        async function copyResultText() { /* ... keep existing code ... */
            const copyButton = document.getElementById('copy-result-btn');
            if (!copyButton) return;
            const textToCopy = getResultTextForSharing();
            if (!textToCopy) { console.warn("No text to copy."); return; }
            try {
                await navigator.clipboard.writeText(textToCopy);
                const originalIcon = copyButton.innerHTML;
                copyButton.innerHTML = '✅'; copyButton.title = 'Скопировано!'; copyButton.style.color = '#08a552';
                setTimeout(() => { if(document.getElementById('copy-result-btn')) { document.getElementById('copy-result-btn').innerHTML = originalIcon; document.getElementById('copy-result-btn').title = 'Скопировать результат'; document.getElementById('copy-result-btn').style.color = ''; } }, 1500);
            } catch (err) {
                console.error('Ошибка копирования: ', err); alert('Не удалось скопировать текст.');
                 const originalIcon = copyButton.innerHTML; copyButton.innerHTML = '❌'; copyButton.title = 'Ошибка копирования'; copyButton.style.color = '#cb0001';
                 setTimeout(() => { if(document.getElementById('copy-result-btn')) { document.getElementById('copy-result-btn').innerHTML = originalIcon; document.getElementById('copy-result-btn').title = 'Скопировать результат'; document.getElementById('copy-result-btn').style.color = ''; } }, 2000);
            }
             hideShareMenu();
         }

        // --- Share Functionality (No changes) ---
        function toggleShareMenu() { /* ... keep existing code ... */
             const menu = document.getElementById('share-menu');
             if (menu) { menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; }
         }
        function hideShareMenu() { /* ... keep existing code ... */
             const menu = document.getElementById('share-menu'); if (menu) { menu.style.display = 'none'; }
         }
        // --- UPDATED VK Share ---
        function shareViaVK() {
            const description = getResultTextForSharing(); // The main content is the result
            const title = "ПоДЕЛИ! - Результат деления"; // Specific title for the shared link/app

            console.log("Sharing to VK - Title:", title);
            console.log("Sharing to VK - Description/Comment:", description); // Debug

            if (!description) {
                console.warn("No result text available for VK sharing description.");
                 // Optionally, share just the link and title
                 // const shareUrl = `https://vk.com/share.php?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
                 // window.open(shareUrl, '_blank', 'noopener,noreferrer');
                 // hideShareMenu();
                 // return;
            }

            // VK share.php uses 'url', 'title' (for the link), and 'comment' (often used for preview text).
            // Pre-filling the user's actual post text is unreliable via URL parameters.
            const shareUrl = `https://vk.com/share.php?title=${encodeURIComponent(title)}&comment=${encodeURIComponent(description)}`; // Limit comment length

            console.log("VK Share URL:", shareUrl);
            window.open(shareUrl, '_blank', 'noopener,noreferrer');
            hideShareMenu();
        }

        // --- UPDATED Telegram Share ---
        function shareViaTelegram() {
            const textToShare = getResultTextForSharing(); // This goes into the message body

            console.log("Sharing to Telegram - Text:", textToShare); // Debug

             if (!textToShare) {
                console.warn("No text available for Telegram sharing.");
                // Optionally, still share the link to the app even without text:
                // const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}`;
                // window.open(shareUrl, '_blank', 'noopener,noreferrer');
                // hideShareMenu();
                return; // Or just return if text is essential
            }

            // Format: ?url=...&text=...
            // url: The link to generate a preview for (our app's URL)
            // text: The text to pre-fill in the message box (Title + our generated result)
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent('Привет! ')}&text=${encodeURIComponent('Обратите внимание, текст обрезан для лимитов браузера: ') + encodeURIComponent(textToShare.substring(0, 700))}`; 

            console.log("Telegram Share URL:", shareUrl);
            window.open(shareUrl, '_blank', 'noopener,noreferrer');
            hideShareMenu();
        }

        function shareViaSMS() {
            const text = getResultTextForSharing();
            console.log("Sharing via SMS - Text:", text); // Debug
             if (!text) {
                console.warn("No text available for SMS sharing.");
                return; // Don't open SMS if no text
            }
            // SMS body has limitations, keep it concise
            const body = text;
            console.log("SMS Body (encoded):", body);
            window.location.href = `sms:?body=${body}`;
            // No need to hideShareMenu here as it might navigate away
        }
        document.addEventListener('click', function(event) { /* ... keep existing code ... */
            const menu = document.getElementById('share-menu');
            const shareButton = document.getElementById('share-result-btn');
            if (menu && menu.style.display === 'block' && !menu.contains(event.target) && shareButton && !shareButton.contains(event.target)) {
                hideShareMenu();
            }
        });

        // --- SVG Icons (No changes) ---
        const svgIconCopy = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`;
        const svgIconShare = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>`;
        const svgIconVK = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.07 2H8.93C3.33 2 2 3.33 2 8.93V15.07C2 20.67 3.33 22 8.93 22H15.07C20.67 22 22 20.67 22 15.07V8.93C22 3.33 20.67 2 15.07 2M18.15 16.27H16.69C16.14 16.27 15.97 15.82 15 14.83C14.12 13.94 13.74 13.71 13.53 13.71C13.24 13.71 13.15 13.83 13.15 14.38V15.69C13.15 16.04 13.04 16.26 12.11 16.26C10.57 16.26 8.86 15.32 7.66 13.59C5.85 11.05 5.36 9.13 5.36 8.75C5.36 8.54 5.43 8.34 5.85 8.34H7.32C7.69 8.34 7.83 8.5 7.97 8.9C8.69 11 9.89 12.8 10.38 12.8C10.57 12.8 10.65 12.71 10.65 12.25V10.1C10.6 9.12 10.07 9.03 10.07 8.68C10.07 8.5 10.21 8.34 10.44 8.34H12.73C13.04 8.34 13.15 8.5 13.15 8.88V11.77C13.15 12.08 13.28 12.19 13.38 12.19C13.56 12.19 13.72 12.08 14.05 11.74C15.1 10.57 15.85 8.76 15.85 8.76C15.95 8.55 16.11 8.35 16.5 8.35H17.93C18.37 8.35 18.47 8.58 18.37 8.89C18.19 9.74 16.41 12.25 16.43 12.25C16.27 12.5 16.21 12.61 16.43 12.9C16.58 13.11 17.09 13.55 17.43 13.94C18.05 14.65 18.53 15.24 18.66 15.65C18.77 16.06 18.57 16.27 18.15 16.27Z"/></svg>`;
        const svgIconTelegram = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9.78,18.65L10.06,14.42L17.74,7.5C18.08,7.19 17.67,7.04 17.22,7.31L7.74,13.3L3.64,12C2.76,11.75 2.75,11.14 3.84,10.7L19.81,4.54C20.54,4.21 21.24,4.72 20.96,5.84L18.24,18.65C18.05,19.56 17.5,19.78 16.74,19.36L12.6,16.3L10.61,18.23C10.38,18.46 10.19,18.65 9.78,18.65Z"/></svg>`;
        const svgIconSMS = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>`;

        // --- Display Results & Filters ---
        function displayRecommendations(filterType = 'equally') {
             let textToShow = "";
             switch (filterType) {
                 case 'equally': textToShow = recommendations.equally; break;
                 case 'who_more_eat_then_more_pay': textToShow = recommendations.who_more_eat_then_more_pay; break;
                 case 'who_more_cost_then_more_pay': textToShow = recommendations.who_more_cost_then_more_pay; break;
                 case 'proportional_division_by_the_cost_of_orders': textToShow = recommendations.proportional_division_by_the_cost_of_orders; break;
                 default: textToShow = recommendations.equally;
             }

             // Clear only the text area content
             resultElement.innerHTML = '';
             // Ensure the wrapper is visible
             resultContainer.style.display = "block";

             // --- NEW: Insert buttons/menu into the wrapper ---
             // First, remove any old buttons/menu from the wrapper if they exist
             const oldButtons = resultContainer.querySelectorAll('.result-action-btn, #share-menu');
             oldButtons.forEach(btn => btn.remove());

             // Create and insert new buttons/menu
             const buttonsAndMenuHTML = `
                 <button id="copy-result-btn" class="result-action-btn" title="Скопировать результат" onclick="copyResultText()">${svgIconCopy}</button>
                 <button id="share-result-btn" class="result-action-btn" title="Поделиться" onclick="toggleShareMenu()">${svgIconShare}</button>
                 <div id="share-menu">
                     <a href="#" onclick="shareViaVK(); return false;">${svgIconVK}<span>ВКонтакте</span></a>
                     <a href="#" onclick="shareViaTelegram(); return false;">${svgIconTelegram}<span>Telegram</span></a>
                     <a href="#" onclick="shareViaSMS(); return false;">${svgIconSMS}<span>SMS</span></a>
                 </div>`;
             // Insert buttons/menu AFTER the #result div within the wrapper
             resultElement.insertAdjacentHTML('afterend', buttonsAndMenuHTML);
             // --- End NEW ---


             // Insert the text content into the #result div
             resultElement.innerHTML = formatOutputText(textToShow || "Рекомендации не найдены.");

             hideShareMenu(); // Ensure menu is hidden initially
        }


        function filter_recommendations(filterType) {
             if (!recommendations || Object.keys(recommendations).length === 0) { return; }
            displayRecommendations(filterType); // This now inserts buttons correctly
            resultElement.scrollTop = 0; // Scroll text area to top
        }

        // --- Upload Logic ---
        async function upload_receipt() {
            const file = imageInput.files[0];
            const numPeople = numPeopleInput.value;
            let tipString = tipAmountInput.value.replace('₽','').trim().replace(',','.');
            const tipAmount = parseFloat(tipString) || 0;

            if (!file || !numPeople || parseInt(numPeople, 10) <= 0) { alert("Пожалуйста, выберите изображение чека и укажите корректное количество людей (> 0)."); return; }
            if (tipAmount < 0) { alert("Сумма чаевых не может быть отрицательной."); tipAmountInput.value = ''; tipAmountInput.focus(); return; }

            uploadButton.disabled = true;
            previewWrapper.style.display = 'none';
            resultContainer.style.display = 'none'; // Hide result wrapper
            resultElement.innerHTML = ''; // Clear text area
            filtersWrapper.style.display = 'none';
            hideShareMenu();

            statusElement.textContent = "Обработка...";
            statusElement.className = 'status processing';
            statusElement.style.display = 'block';

            const formData = new FormData();
            formData.append("receipt_image", file);
            formData.append("num_people", numPeople);
            formData.append("tea_money", tipAmount);

            let statusTimer = null;

            try {
                const response = await fetch('/upload_receipt', { method: "POST", body: formData });
                clearTimeout(statusTimer);

                if (!response.ok) {
                    let errorMsg = `Ошибка ${response.status}`;
                    try { const errorData = await response.json(); errorMsg = errorData.detail || errorData.message || errorMsg; } catch (e) { errorMsg = `Ошибка ${response.status}: ${response.statusText}`; }
                    statusElement.textContent = errorMsg;
                    statusElement.className = 'status error';
                    statusElement.style.display = 'block';
                    throw new Error(errorMsg);
                }

                const responseData = await response.json();
                console.log("Получены данные:", responseData);

                if (responseData.is_restaurant === true) {
                    recommendations = responseData;
                    statusElement.textContent = "Обработка завершена!";
                    statusElement.className = 'status success';
                    statusElement.style.display = 'block';
                    statusTimer = setTimeout(() => { statusElement.style.display = 'none'; }, 1800);

                    displayRecommendations('equally'); // Shows wrapper, inserts text and buttons
                    filtersWrapper.style.display = "flex"; // Show filters below inputs

                    setTimeout(() => {
                         containerElement.scrollTo({ top: containerElement.scrollHeight, behavior: 'smooth' });
                     }, 100);

                } else {
                    const errorText = "Ошибка: Загруженное изображение не похоже на чек из ресторана.";
                    statusElement.textContent = errorText;
                    statusElement.className = 'status error';
                    statusElement.style.display = 'block';
                    recommendations = {};
                    resultContainer.style.display = "none"; // Hide result wrapper
                    filtersWrapper.style.display = "none"; hideShareMenu();
                }

            } catch (error) {
                console.error("Ошибка при обработке чека:", error);
                clearTimeout(statusTimer);
                 if (statusElement.style.display === 'none' || !statusElement.classList.contains('error')) {
                    statusElement.textContent = `Ошибка: ${error.message || "Не удалось обработать чек"}`;
                    statusElement.className = 'status error';
                    statusElement.style.display = 'block';
                 }
                recommendations = {};
                resultContainer.style.display = "none"; // Hide result wrapper
                filtersWrapper.style.display = "none"; hideShareMenu();
            } finally {
                toggleUploadButton();
            }
        }

        // --- Initial Setup & Event Listeners ---
        window.onload = () => {
             toggleUploadButton();
             hideShareMenu();
             if (tipAmountInput.value) { formatTipInput(tipAmountInput); }

             document.body.addEventListener('click', (event) => {
                 if (statusElement.style.display !== 'none' && !statusElement.contains(event.target)) {
                    const isProcessing = statusElement.classList.contains('processing');
                    const clickedUpload = uploadButton.contains(event.target);
                     if (!(isProcessing && clickedUpload)) {
                          statusElement.style.display = 'none';
                     }
                 }
             }, true);
        };
    </script>

</body>
</html>